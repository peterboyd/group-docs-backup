<!DOCTYPE html>
<html>
    <head>
        <title>GENTOO - Tips and Tweaks</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    </head>
    <body>
        <b>TITLE OF THE DOCUMENT (just copy/paste it):</b>
        <div style="border: 2px solid; padding: 10px; margin: 10px 50px 50px;">
             GENTOO - Tips and Tweaks
        </div>

        <b>CONTENT OF THE DOCUMENT (just copy/paste it):</b>
        <div style="border: 2px solid; padding: 10px; margin: 10px 50px;">
            <p>This document will cover some useful tips and tricks about Gentoo.</p>
<p>It is a work in progress, so expect more and feel free to add to it or alter it in any way you think is suitable.</p>
<p> </p>
<p><strong>Speeding up compilation in Gentoo</strong></p>
<p><strong>===========================</strong></p>
<p>One thing that really bothers most Gentoo users, is the time it takes to compile new packages or update the installed ones. So here are some tweaks you may use to speed the process up. Be sure to make a backup  of the files you alter <strong>PRIOR </strong>to any change you make. In the example, we assume that your CPU is a quad core one and is having HT.</p>
<ol><li>
<p><strong>Tweaks made to </strong><strong><em>/etc/make.conf </em></strong><strong>. </strong>Check if your config has the listed variables and if so, just replace them with the proposed one. If it doesn&#039;t have them, just add them on a new line.</p>
<ol><li>
<p><em>CFLAGS=&quot;-march=native -O2 -pipe&quot;</em></p>
</li>
<li>
<p><em>CXXFLAGS=&quot;$&#123;CFLAGS&#125;&quot; </em></p>
<p><strong>NOTES: </strong> Using <em>-march=native</em> is best, but it makes impossible to use <em>distcc</em> if the other machines has a different setting and have a different kind of CPU.</p>
</li>
<li>
<p><em>MAKEOPTS=&quot;-j9&quot;</em></p>
<p><strong>NOTES: </strong>The <em>-j</em> value is calculated as the: <em>Number of CPUs/Cores X 2 (if you have HT) + 1</em>. So for a quad core CPU, if you do not have HT it should be 5 and if you have – 9. Using a higher value may result in worse  performance when it comes to compilation time. This option has nothing to do with the <em>-j/--jobs</em> option of the ebuild command. Please refer to the emerge manual for more info. If you use <em>distcc</em>, the value of <em>-j</em> is calculated the same way, just count all the cores of all the CPUs that are available.</p>
</li>
<li>
<p><em>PORTAGE_TMPDIR=&quot;/dev/shm&quot;</em></p>
<p><strong>NOTES:</strong> This is part of tweak 2 and is here to make all the compilation use a tmpfs, so everything to be speed up. If your RAM is less than 4GB, you&#039;d better not use this tweak and this variable.</p>
</li>
<li>
<p><em>FEATURES=&quot;$&#123;FEATURES&#125;  fail-clean&quot;</em></p>
<p><strong>NOTES:</strong> This is part of tweak 2 as well and is making all the temp files of the compilation process to be removed when the compilation fails.  This way you preserve your free RAM, but the downside is that you  lose the temp files that may be used for debugging why the compilation failed.</p>
</li>
</ol></li>
<li>
<p><strong>Tweaks using a tmpfs for the compilation. </strong>You may use these if your RAM is 4GB at least.</p>
<ol><li>
<p>You need to have a kernel with <em>swap</em> and <em>Virtual memory file system support</em> enabled. Almost all default kernel configurations have these enabled.</p>
</li>
<li>
<p>Add this line to your <em>/etc/fstab</em> :</p>
<p><em><strong>shm /dev/shm tmpfs defaults 0 0</strong></em></p>
<p><em><strong>NOTES:</strong> </em>The <em>defaults</em> option will actually use ½ of your available RAM, so if you have 4GB of RAM only <strong>UP </strong>to 2GB of them will be used for the tmpfs. The process is dynamic, i.e. only the required quantity of RAM is used.</p>
</li>
<li>
<p>Create a<strong> <em>/etc/portage/env/notmpfs.conf </em></strong>file and put inside it this line:</p>
<p><em><strong>PORTAGE_TMPDIR=&quot;/var/tmp&quot;</strong></em></p>
<p><strong>NOTES: </strong>This file will be used to tell emerge not to use the tmpfs for large applications that need much more free disk space for compilation... like Firefox, Libreoffice, kdelibs etc.</p>
</li>
<li>
<p>Create a<strong> <em>/etc/portage/package.env </em></strong>file. This file will be used to put one DEPEND atom per line followed by name of the above environment file. By &quot;DEPEND atom&quot; I mean the name of the package as used in portage. For example add these known big compilation disk space “eaters”:</p>
<p><em><strong>www-client/firefox 	notmpfs.conf</strong></em></p>
<p><em><strong>kde-base/kdelibs notmpfs.conf</strong></em></p>
<p><em><strong>app-office/libreoffice notmpfs.conf</strong></em></p>
<p><em><strong>mail-client/thunderbird notmpfs.conf</strong></em></p>
</li>
<li>
<p><strong>YOU ARE DONE WITH THE TWEAKS. </strong>After rebooting the emerge of all packages should be a way faster than before.</p>
</li>
</ol></li>
</ol><p> </p>
<p> </p>
<p> </p>
<p><strong>Updating your Gentoo</strong></p>
<p><strong>=================</strong><strong> </strong></p>
<p>There are a lot of ways to update your Gentoo, but having a step by step guidance to follow is a good thing. Here I will describe my way of doing it. It is nothing special, but may help some novice Gentoo users:</p>
<ol><li>
<p><strong>Tweaks made to </strong><strong><em>/etc/make.conf </em></strong><strong>. </strong>This 	is a one time config. Check if your config has the listed variables and if so, just replace them with the proposed one. If it doesn&#039;t 	have them, just add them on a new line.</p>
<ol><li>
<p><em>ACCEPT_LICENSE=&quot;*&quot;</em></p>
<p><strong><strong>NOTES: </strong></strong>Add this so you would not be bothered by some license agreement acceptance when you install/update certain packages.</p>
</li>
<li>
<p><em>FEATURES=&quot;$&#123;FEATURES&#125; parallel-fetch&quot;</em></p>
<p><strong><strong>NOTES: </strong></strong>This helps speeding up fetching the sources for the ebuilds that would be emerged while the compilation is running. You can always see the progress of the fetching using the command <em>“tail -f /var/log/emerge-fetch.log”</em></p>
</li>
<li>
<p><em>EMERGE_DEFAULT_OPTS=&quot;$&#123;EMERGE_DEFAULT_OPTS&#125; --keep-going y&quot;</em></p>
<p><strong><strong>NOTES: </strong></strong>This is a very useful option that will be automatically added to every emerge command you issue. It helps the emerge to go on with the next packages if a package fails to build. By default if a package fails to build the emerge process stops issuing the error. This way if you have a lot of packages to update, you will need to stay close to the terminal  and watch for such errors. But if you use <em>-keep-going y, </em>the emerge process will continue till the end, and at the end it will show you which packages failed to build, so then you can try debugging/fixing them.</p>
</li>
</ol></li>
<li>
<p>Issue <strong><em><strong>emerge –sync </strong></em></strong><em> </em>and wait till it ends. Sometimes at the end it says you should update your portage package. If so do it by: <strong><em><strong>emerge 	portage. </strong></em></strong><em> </em>Do everything else that emerge tells you should do.</p>
</li>
<li>
<p>Issue <strong><em><strong>emerge -avuND world </strong></em></strong><strong> . </strong>Review all the changes that will be done and hit Enter to 	continue. If there are some packages that have a fetch restriction, you need to download them manually first, so answer “NO” to emerge, download the needed package sources, put them in <em>/usr/portage/distfiles</em> and run <strong><em>emerge -avuND world </em></strong>again.</p>
</li>
<li>
<p>When the previous command ends, review the output and commit any changes described by portage that should be done. Do not worry if there are some failed packages. Just take note of them and go to the next step.</p>
</li>
<li>
<p>You should now issue <strong>emerge -cav </strong>to perform a depclean following an update. This will launch <strong>emerge --depclean --ask --verbose</strong> which will remove reduntant packages. This will unmerge packages with no reverse dependencies (often as a result of disabling a use flag) to prevent undeeded packages from being on your system. The packages to be unmerged must be carefully reviewed before accepting as it can remove needed packages with no dependencies (such as nano). </p>
<p> </p>
<p>You should now issue <strong><em><strong>revdep-rebuild -i -v -- -a . </strong></em></strong>This way you will check your system for consistency. It doesn&#039;t matter if step 3 ended with no errors. And if in step 4 you have problem packages that have not compiled, this step may help when trying to compile them again.</p>
<p><strong><strong>NOTES: </strong></strong>In order to use this command, you need to have <em>app-portage/gentoolkit </em>installed. 	So if you do not have it do: <strong>emerge 	app-portage/gentoolkit</strong> PRIOR to use it.</p>
</li>
<li> <ol><li>
<p><strong>If  step 5 ends ok AND you had some packages that failed to build, </strong>do the <strong><em><strong>emerge -avuND world </strong></em></strong> AGAIN<strong>. </strong>Most of the problems are fixed this way. But you may need to go through step 5 and 6 a couple of times. If all this doesn&#039;t help, the problem can be resolved EITHER by visiting <strong>http://bugs.gentoo.org </strong>and trying to find info about that specific error OR by masking the problematic version. The masking is done as you put an entry in <em>/etc/portage/package.mask . </em>For example if the offending package is <em>dev-lang/gnat-gcc-4.3.6, </em>you put in the file this line:</p>
<p><strong><em><strong>=dev-lang/gnat-gcc-4.3.6</strong></em></strong></p>
</li>
<li>
<p><strong><em><strong>If step 5 ends ok AND you had no failed packages... You are done with the update.</strong></em></strong></p>
</li>
</ol></li>
</ol><p> </p>
<p>ALTERNATIVE TREE MANAGEMENT</p>
<p>======================</p>
<p>Issuing emerge --search <em>&lt;package-name&gt; </em>can be a fairly slow process compared to that of pacman and others. Thankfully a tool exists which vastly speeds up this process called <strong>eix</strong>. This tool can be installed by issuing <strong>emerge eix</strong>.</p>
<p> </p>
<ol><li><strong>Syncing your Gentoo tree</strong>: Instead of issuing <strong>emerge --sync</strong> you can use <strong>eix-sync</strong> which will run <strong>emerge --sync </strong>and <strong>eix-update </strong>to update eix&#039;s database. If you have recently synced your tree before installing eix, you can simply use <strong>eix-update</strong> to update eix&#039;s database and save syncing again. <strong>eix-sync </strong>will also run <strong>eix-diff</strong> to show which packages have been updated/downgraded since the last time you synced, a very useful feature for planning updates. If you have added an overlay using layman, you must run <strong>eix-update</strong> afterwards to include the overlay&#039;s packages in your eix searches. </li>
<li><strong>Package Searching</strong>: to search for a package, simply use <strong>eix &lt;package name&gt;</strong>. You will notice the search is instant, as opposed to the slow <strong>emerge --search &lt;package name&gt;</strong>. Note that you don&#039;t have to input the full package name when using eix, for example; <strong>eix emer </strong>will display packages such as emerge, emerald-themes and other possibilities. The search output will display which version of the package you have installed, which use flags exist and which use flags your installed version has. </li>
<li><strong>Other eix functions</strong>: <strong>eix-installed all</strong> will display every package installed on your system. This can be customised to display repo information and more. <strong>eix-layman </strong>can be used to manage overlays, for example, <strong>eix-layman -a &lt;overlay&gt;</strong> will clone the git repo (or subversion) and update the eix database with the new overlay&#039;s packages. This will save you from running <strong>layman -a &lt;overlay&gt;</strong> and <strong>eix-update</strong>. </li>
</ol><p> </p>
<p>NEXT TWEAK</p>
<p>=========</p>
<p>TO BE CONTINUED....</p>
        </div>
    </body>
</html>
