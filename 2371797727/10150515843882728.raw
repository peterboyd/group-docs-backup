{"can_edit": true, "from": {"name": "Ljubomir Ljubojevic", "id": "100000182091980"}, "revision": "10150515847072728", "updated_time": "2012-01-07T22:14:22+0000", "created_time": "2012-01-07T22:12:37+0000", "message": "<p><em>Author: Jeff Sheltren</em></p>\n<p>\u00a0</p>\n<p>I see a lot of people coming by #centos and similar channels asking for  help when they\u2019re experiencing a problem with their Linux system.  It  amazes me how many people describe their problem, and then say something  along the lines of, \u201cand I disabled SELinux...\u201d.  Most of the time  SELinux has nothing to do with the problem, and if SELinux is the cause  of the problem, why would you throw out the extra security by disabling  it completely rather than configuring it to work with your application?   This may have made sense in the Fedora 3 days when selinux settings and  tools weren\u2019t quite as fleshed out, but the tools and the default  SELinux policy have come a long way since then, and it\u2019s very worthwhile  to spend a little time to understand how to configure SELinux instead  of reflexively disabling it.  In this post, I\u2019m going to describe some  useful tools for SELinux and walk through how to configure SELinux to  work when setting up a Drupal web site using a local memcached server  and a remote MySQL database server -- a pretty common setup for sites  which receive a fair amount of traffic.</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Too Long; Didn\u2019t Read Version</strong></em></li>\n</ul><p>If you\u2019re in a hurry to figure out how to configure SELinux for this  particular type of setup, on CentOS 6, you should be able to use the  following two commands to get things working with SELinux:</p>\n<p># setsebool -P httpd_can_network_connect_db 1</p>\n<p># setsebool -P httpd_can_network_memcache 1</p>\n<p>\u00a0</p>\n<p>Note that if you have files existing somewhere on your server and you  move them to the webroot rather than untar them there directly, you may  end up with SELinux file contexts set incorrectly on them which will  likely deny access to apache to read those files.  If you are having a  related problem, you\u2019ll see something like this in your  /var/log/audit/audit.log:</p>\n<p>type=AVC  msg=audit(1324359816.779:66): avc:  denied  &#123; getattr &#125; for  pid=3872  comm=&quot;httpd&quot; path=&quot;/var/www/html/index.php&quot; dev=dm-0 ino=549169  scontext=root:system_r:httpd_t:s0 tcontext=root:object_r:user_home_t:s0  tclass=file</p>\n<p>\u00a0</p>\n<p>You can solve this by resetting the webroot to its default file context using the restorecon command:</p>\n<p># restorecon -rv /var/www/html</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Server Overview</strong></em></li>\n</ul><p>I\u2019m going to start with a CentOS 6 system configured with SELinux in  targeted mode, which is the default configuration.  I\u2019m going to be  using httpd, memcached, and PHP from the CentOS base repos, though the  configuration wouldn\u2019t change if you were to use the IUS PHP packages.   MySQL will be running on a remote server which gives improved  performance, but means a bit of additional SELinux configuration to  allow httpd to talk to a remote MySQL server.  I\u2019ll be using Drupal 7 in  this example, though this should apply to Drupal 6 as well without any  changes.</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Initial Setup</strong></em></li>\n</ul><p>Here we will setup some prerequisites for the website.  If you already have a website setup you can skip this section.</p>\n<p>\u00a0</p>\n<p>We will be using tools such as audit2allow which is part of the  policycoreutils-python package.  I believe this is typically installed  by default, but if you did a minimal install you may not have it.</p>\n<p># yum install policycoreutils-python</p>\n<p>\u00a0</p>\n<p>Install the needed apache httpd, php, and memcached packages:</p>\n<p># yum install php php-pecl-apc php-mbstring php-mysql php-pecl-memcache php-gd php-xml httpd memcached</p>\n<p>\u00a0</p>\n<p>Startup memcached.  The CentOS 6 default configuration for memcached  only listens on 127.0.0.1, this is great for our testing purposes.  The  default of 64M of RAM may not be enough for a production server, but for  this test it will be plenty. We\u2019ll just start up the service without  changing any configuration values:</p>\n<p># service memcached start</p>\n<p>\u00a0</p>\n<p>Startup httpd.  You may have already configured apache for your  needs, if not, the default config should be enough for the site we\u2019ll be  testing.</p>\n<p>\u00a0</p>\n<p># service httpd start</p>\n<p>If you are using a firewall, then you need to allow at least port 80  through so that you can access the website -- I won\u2019t get into that  configuration here.</p>\n<p>\u00a0</p>\n<p>Install Drupal.  I\u2019ll be using the latest Drupal 7 version (7.9 as of this writing).  Direct link: http://ftp.drupal.org/files/projects/drupal-7.9.tar.gz</p>\n<p>Download the tarball, and expand it to the apache web root.  I also use  the --strip-components=1 argument to strip off the top level directory,  otherwise it would expand into /var/www/html/drupal-7.9/</p>\n<p>\u00a0</p>\n<p># tar zxf drupal-7.9.tar.gz -C /var/www/html --strip-components=1</p>\n<p>Also, we need to get the Drupal site ready for install by creating a  settings.php file writable by apache, and also create a default files  directory which apache can write to.</p>\n<p># cd /var/www/html/sites/default/</p>\n<p># cp default.settings.php settings.php</p>\n<p># chgrp apache settings.php &amp;&amp; chmod 660 settings.php</p>\n<p># install -d -m 775 -g apache files</p>\n<p>\u00a0</p>\n<p>Setup a database and database user on your MySQL server for Drupal.  This would be something like this:</p>\n<p>mysql&gt; CREATE DATABASE drupal;</p>\n<p>mysql&gt; GRANT ALL ON drupal.* TO drupal_rw&#064;web-server-ip-here IDENTIFIED BY &#039;somepassword&#039;;</p>\n<p>\u00a0</p>\n<p>Test this out by using the mysql command line tool on the web host.</p>\n<p># mysql -u drupal_rw -p -h  drupal</p>\n<p>That should connect you to the remote MySQL server.  Be sure that is working before you proceed.</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Now for the Fun Stuff</strong></em></li>\n</ul><p>If you visit your new Drupal site at http://your-hostname-here,  you\u2019ll be presented with the Drupal installation page.  Click ahead a  few times, setup your DB info on the Database Configuration page -- you  need to expand \u201cAdvanced Options\u201d to get to the hostname field since it  assumes localhost.  When you click the button to proceed, you\u2019ll  probably get an unexpected error that it can\u2019t connect to your database  -- this is SELinux doing its best to protect you!</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Allowing httpd to Connect to a Remote Database</strong></em></li>\n</ul><p>So what just happened?  We know the database was setup properly to  allow access from the remote web host, but Drupal is complaining that it  can\u2019t connect.  First, you can look in /var/log/audit/audit.log which  is where SELinux will log access denials.  If you grep for \u2018httpd\u2019 in  the log, you\u2019ll see something like the following:</p>\n<p># grep httpd /var/log/audit/audit.log</p>\n<p>type=AVC msg=audit(1322708342.967:16804): avc:  denied  &#123; name_connect &#125;  for  pid=2724 comm=&quot;httpd&quot; dest=3306  scontext=unconfined_u:system_r:httpd_t:s0  tcontext=system_u:object_r:mysqld_port_t:s0 tclass=tcp_socket</p>\n<p>\u00a0</p>\n<p>That is telling you, in SELinux giberish language, that the httpd  process was denied access to connect to a remote MySQL port.  For a  better explanation of the denial and some potential fixes, we can use  the \u2018audit2why\u2019 utility:</p>\n<p># grep httpd /var/log/audit/audit.log | audit2why</p>\n<p>type=AVC msg=audit(1322708342.967:16804): avc:  denied  &#123; name_connect &#125;  for  pid=2724 comm=&quot;httpd&quot; dest=3306  scontext=unconfined_u:system_r:httpd_t:s0  tcontext=system_u:object_r:mysqld_port_t:s0 tclass=tcp_socket</p>\n<p>\u00a0</p>\n<p>Was caused by:</p>\n<p>One of the following booleans was set incorrectly.</p>\n<p>Description:</p>\n<p>Allow HTTPD scripts and modules to connect to the network using TCP.</p>\n<p>\u00a0</p>\n<p>Allow access by executing:</p>\n<p># setsebool -P httpd_can_network_connect 1</p>\n<p>Description:</p>\n<p>Allow HTTPD scripts and modules to connect to databases over the network.</p>\n<p>\u00a0</p>\n<p>Allow access by executing:</p>\n<p># setsebool -P httpd_can_network_connect_db 1</p>\n<p>\u00a0</p>\n<p>audit2why will analyze the denial message you give it and potentially  explain ways to correct it if it is something you would like to allow.   In this case, there are two built in SELinux boolean settings that  could be enabled for this to work.  One of them,  httpd_can_network_connect, will allow httpd to connect to anything on  the network.  This might be useful in some cases, but is not very  specific.  The better option in this case is to enable  httpd_can_network_connect_db which limits httpd generated network  connections to only database traffic.  Run the following command to  enable that setting:</p>\n<p># setsebool -P httpd_can_network_connect_db 1</p>\n<p>\u00a0</p>\n<p>It will take a few seconds and not output anything.  Once that  completes, go back to the Drupal install page, verify the database  connection info, and click on the button to continue.  Now it should  connect to the database successfully and proceed through the  installation.  Once it finishes, you can disable apache write access to  the settings.php file:</p>\n<p>\u00a0</p>\n<p># chmod 640 /var/www/html/sites/default/settings.php</p>\n<p>Then fill out the rest of the information to complete the installation.</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Allowing httpd to connect to a memcached server</strong></em></li>\n</ul><p>Now we want to setup Drupal to use memcached instead of storing cache  information in MySQL.  You\u2019ll need to download and install the Drupal  memcache module available here: http://drupal.org/project/memcache</p>\n<p>Install that into your Drupal installation, and add the appropriate  entries into settings.php.  For this site, I did that with the  following:</p>\n<p># mkdir /var/www/html/sites/default/modules</p>\n<p># tar zxf memcache-7.x-1.0-rc2.tar.gz -C /var/www/html/sites/default/modules</p>\n<p>\u00a0</p>\n<p>Then edit settings.php and add the following two lines:</p>\n<p>$conf[&#039;cache_backends&#039;][] = &#039;sites/default/modules/memcache/memcache.inc&#039;;</p>\n<p>$conf[&#039;cache_default_class&#039;] = &#039;MemCacheDrupal&#039;;</p>\n<p>\u00a0</p>\n<p>Now if you reload your site in your web browser, you\u2019ll likely see a  bunch of memcache errors -- just what you wanted!  I bet it\u2019s SELinux at  it again!  Check out /var/log/audit/audit.log again and you\u2019ll see  something like:</p>\n<p>type=AVC msg=audit(1322710172.987:16882): avc:   denied  &#123; name_connect &#125; for  pid=2721 comm=&quot;httpd&quot; dest=11211  scontext=unconfined_u:system_r:httpd_t:s0  tcontext=system_u:object_r:memcache_port_t:s0 tclass=tcp_socket</p>\n<p>\u00a0</p>\n<p>That\u2019s very similar to the last message, but this one is for a memcache port.  What does audit2why have to say?</p>\n<p># grep -m 1 memcache /var/log/audit/audit.log | audit2why</p>\n<p>type=AVC msg=audit(1322710172.796:16830): avc:  denied  &#123; name_connect &#125;  for  pid=2721 comm=&quot;httpd&quot; dest=11211  scontext=unconfined_u:system_r:httpd_t:s0  tcontext=system_u:object_r:memcache_port_t:s0 tclass=tcp_socket</p>\n<p>\u00a0</p>\n<p>Was caused by:</p>\n<p>One of the following booleans was set incorrectly.</p>\n<p>Description:</p>\n<p>Allow httpd to act as a relay</p>\n<p>\u00a0</p>\n<p>Allow access by executing:</p>\n<p># setsebool -P httpd_can_network_relay 1</p>\n<p>Description:</p>\n<p>Allow httpd to connect to memcache server</p>\n<p>\u00a0</p>\n<p>Allow access by executing:</p>\n<p># setsebool -P httpd_can_network_memcache 1</p>\n<p>Description:</p>\n<p>Allow HTTPD scripts and modules to connect to the network using TCP.</p>\n<p>\u00a0</p>\n<p>Allow access by executing:</p>\n<p># setsebool -P httpd_can_network_connect 1</p>\n<p>\u00a0</p>\n<p>Again, audit2why gives us a number of options to fix this.  The best  bet is to go with the smallest and most presice change for our needs.   In this case there\u2019s another perfect fit: httpd_can_network_memcache.   Enable that boolean with the following command:</p>\n<p># setsebool -P httpd_can_network_memcache 1</p>\n<p>Success!  Now httpd can talk to memcache.  Reload your site a couple  of times and you should no longer see any memcache errors.  You can be  sure that Drupal is caching in memcache by connecting to the memcache  CLI (telnet localhost 11211) and typing \u2018stats\u2019.  You should see some  number greater than 0 for \u2018get_hits\u2019 and for \u2018bytes\u2019.</p>\n<p>\u00a0</p>\n<ul><li><em><strong>What are all these booleans anyway?</strong></em></li>\n</ul><p>Now we\u2019ve used a couple SELinux booleans to allow httpd to connect to  memcached and MySQL.  You can see a full list of booleans which you can  control by using the command \u2018getsebool -a\u2019.  They are basically a  preset way for you to allow/deny certain pre-defined access controls.</p>\n<p>\u00a0</p>\n<ul><li><em><strong>Restoring default file contexts</strong></em></li>\n</ul><p>As I mentioned briefly in the \u2018TL;DR\u2019 section, another common problem  people experience is with file contexts.  If you follow my instructions  exactly, you won\u2019t have this problem because we untar the Drupal files  directly into the webroot, so they will inherit the default file context  for /var/www/html.  If, however, you were to untar the files in your  home directory, and then use \u2018mv\u2019 or \u2018cp\u2019 to place them in  /var/www/html, they will maintain the user_home_t context which apache  won\u2019t be able to read by default.  If this is happening to you, you will  see the file denials logged in /var/log/audit/audit.log -- something  like this:</p>\n<p>type=AVC msg=audit(1324359816.779:66): avc:  denied   &#123; getattr &#125; for  pid=3872 comm=&quot;httpd&quot; path=&quot;/var/www/html/index.php&quot;  dev=dm-0 ino=549169 scontext=root:system_r:httpd_t:s0  tcontext=root:object_r:user_home_t:s0 tclass=file</p>\n<p>\u00a0</p>\n<p>The solution in this case is to use restorecon to reset the file contexts back to normal:</p>\n<p># restorecon -rv /var/www/html</p>\n<p>\u00a0</p>\n<p>\u00a0</p>\n<p><em><strong>Update:</strong> </em>It was noted that I should also mention  another tool for debugging audit messages, &#039;sealert&#039;.  This is provided  in the setroubleshoot-server package and will also read in the audit  log, similar to what I described with audit2why.</p>\n<p># sealert -a /var/log/audit/audit.log</p>\n<p>More on SELinux read at:</p>\n<p>http://wiki.centos.org/HowTos/SELinux</p>\n<p>http://fedoraproject.org/wiki/SELinux/Understanding</p>\n<p>http://fedoraproject.org/wiki/SELinux/Troubleshooting</p>\n<p>\u00a0</p>\n<p>This text was originally published on http://planet.centos.org/ (Dec. 21. 2011)</p>", "subject": "Stop Disabling SELinux! ", "id": "10150515843882728", "icon": "https://fbstatic-a.akamaihd.net/rsrc.php/v2/yi/r/-64q65AWgXb.png"}