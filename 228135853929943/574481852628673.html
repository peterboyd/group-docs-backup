<!DOCTYPE html>
<html>
    <head>
        <title>Data recovery - when bad sectors are involved.</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    </head>
    <body>
        <b>TITLE OF THE DOCUMENT (just copy/paste it):</b>
        <div style="border: 2px solid; padding: 10px; margin: 10px 50px 50px;">
             Data recovery - when bad sectors are involved.
        </div>

        <b>CONTENT OF THE DOCUMENT (just copy/paste it):</b>
        <div style="border: 2px solid; padding: 10px; margin: 10px 50px;">
            <p><b>Preface:</b><br />First of all, there are a verity of things that can cause media to fail. This is why the old throwing your drive in the freezer trick isn&#039;t always ideal unless you can confirm that you have a particular drive issue. So this is my little disclaimer - when you have confirmed your failure is the result of bad sectors this guide is tailored for you.</p><p><br /></p><p>Incidentally this is more or less how the pros scavenge your hard drive when you&#039;ve been up to no good.</p><p><br /></p><p><b>Tools:</b></p><p><b></b><u>ddrescue</u> - It drives me up a wall when people recommend dd for data recovery (you know who you are - I will flame you if I&#039;m not doing something more important!), ddrescue is essentially the same functionality as dd but it takes into account the fact that the media you are working with could be damaged, which makes the difference between getting files back and grinding your platters to dust or burning your NAND up.</p><p><br /></p><p><u>fsck</u> - Standard issue Unix File Sytem Consistency Check utility. (this is assuming you are using a &quot;native&quot; file system, since FAT isn&#039;t journaled using dosfsck usually doesn&#039;t do any good, and a native win32 chkdsk is really the only way to deal with truly damaged NTFS systems, the tool from ntfs-3g will do more damage in this case)</p><p><br /></p><p><u>TestDisk</u> - This nifty tool may or may not be needed depending on how much damage was done to your partition table and file system, it can also recover dereferenced files (a.k.a. &quot;deleted&quot;)<br /></p><p><br /></p><p><u>losetup</u> - Standard Linux loop device management utility<br /></p><p><br /></p><p><u>mount/umount</u> - If you don&#039;t know how to use this yet, turn away now, don&#039;t say I didn&#039;t warn you.<br /></p><p><br /></p><p><b>Procedure:</b><br /></p><p><br /></p><p><u>Phase 1</u></p><p>We need to make a forensic copy of your drive, incidentally if your file system and partition table isn&#039;t recognized, plug the media in anyways because we&#039;re working with the block level so that doesn&#039;t matter (yet). This entails making a clone of _EVERY_ sector (or block, I&#039;ll use sector and block interchangeability here, sorry, bad habit). So make sure you have enough free space, in this guide I&#039;ll be using an image because I find that more convenient to work with, you could always do disk to disk cloning but you are on your own if you choose that route.</p><p>We do this so that we don&#039;t have to worry about <b>the drive dying </b>on us while recovering data, or botching up data.</p><p><br /></p><p>Adjust your paths accordingly - its important that you add the log, this will let us make multiple passes, keep track of sectors to come back to (initially bad or slow sectors are skipped to get as much data as possible), and resume the image later even you are interrupted for some reason. (told you ddrescue was better at this then dd)</p><p><u>First pass</u>; the n option tells ddrescue not to retry bad sectors or to split (I&#039;ll explain that in more detail later, but its another reason you want to use ddrescue for this not dd). Depending on the size of your disk you may want to get on with life for a day or two, I&#039;ve seen little 16 GB flash drives take upwards of a couple hours to finish pass one.<br /></p><p><br /></p><p><i>~$ ddrescue -n -v /dev/DAMAGED_DISK /image.img /ddrescue.log</i></p><p><br /></p><p><u>Second pass</u>; in the first pass we skipped over bad and slow sectors in an attempt to recover as much data as possible, now we are going to go back and grind away at these sectors a few more times. -r 3 will say after 3 tries move on, -d will directly access the disk rather then using the kernel buffer. ddrescue is smart enough to use the log file to go back and hit bad sectors. This could also take some time.</p><p><br /></p><p><i>~$ ddrescue -r 3 -d -v /dev/DAMAGED_DISK /image.img /ddrescue.log</i></p><p><br /></p><p>On splitting and trimming: Sectors are the smallest allocateable unit of storage space - as far as your operating system is concerned. Traditionally sectors are 512 bytes and newer drives in the terabytes often have 4096 bytes per sector; this means that not all of a sector is necessarily bad. Splitting and trimming will have ddrescue go back over a sector and try to find accessible bytes, resulting in more data then if bad sectors were simply ignored.</p><p><br /></p><p><u>Phase 2</u></p><p>Pro Tip - if you have enough storage space, now is a good time to make a copy of this image, just in case you screw up.</p><p><br /></p><p>Ok, now that we have our image we need to trick the operating system into treating it like a physical drive. After running this command we&#039;ll be able to treat /dev/loop0 like a device node representing a drive (e.g. /dev/sda) only we&#039;ll be manipulating our image instead.</p><p><br /></p><p><i>~$ losetup /dev/loop0 /image.img</i></p><p><br /></p><p>If your image has a bad partition table AND you are using a journaled file system like ext4, you may simply be able to create a new partition table on top of the image (using a tool like fdisk), you just need to make sure it starts in exactly the same spot and stop either at the exact same spot, then fsck the file system.</p><p><b>Only use this if phase 3 does not yield results!</b><br />This tick doesn&#039;t work with FAT file systems unfortunately.<br /><br /><b>If you are fairly certain your partition table was damaged, skip ahead to phase 3.</b><br /><br />Lets see if fsck can do anything for us, the N option will prevent anything from being written to the image just yet until we are sure:<br /><br /><i>~$ fsck -N -V /dev/loop0</i><br /><br />At this point it may be necessary to use the file system specific fsck tool (e.g. e2fsck) since the fsck wrapper utility may not be able to detect the file system in use.</p><p><br /></p><p>Its entirely possible that fsck might not be able to help us here, move on to <b>phase 3</b> in that case. Lets try mounting the file system, its important to use the ro (read-only) option with mount, this allows us to preserve the integrity of our image. Also you may need to use the -t option to let mount know what file system driver to use.<br /><br /><i>~$ mount -o ro -t FILE_SYSTEM /dev/loop0 /mnt</i><br /><br />If that worked, you are now free to poke around the file system at your leisure, copying what data you want to.</p><p><br /></p><p>Don&#039;t forget to unmount your file system when you are done. And when you are done with your loopback device you can disassociate it with your image like so:<br /><br /><i>~$ losetup -d /dev/loop0</i></p><p><br /></p><p>Sit back, pat yourself on the back, hopefully the experience taught you its cheaper just to buy a couple more disks and have a good backup handy.</p><p><br /></p><p><u>Phase 3</u><br /></p><p>You are at phase 3 because there was too much damage to either your partition table or your file system to recover data. In this case you should still have your loop back device loop0 associate with the image.</p><p>We&#039;ll use a tool called TestDisk that has a few different approach to handling data and usually file pointers or even partition tables don&#039;t need to be intact, it just deals with raw data.<br /><br /><i>~$ testdisk /dev/loop0</i></p><p><br /></p><p>- It should only show you /dev/loop0, go ahead and select proceed.</p><p>- You will need to know what kind of partition table you have, chances are if you arn&#039;t sure, you&#039;ll want Intel/PC</p><p>- Select Analyse and do a Quick Search</p><p>- If this doesn&#039;t turn up your partition you may need to do a Deeper Search</p><p>- Once you have found your partition, go back to the main menu and choose [Advanced] File system utilities</p><p>- Choose undelete</p><p>- You can use &#039;a&#039; to select all files and &#039;C&#039; to copy those files, it will prompt you to find a location to copy them to. Anything hilighted in red was a previously deleted file.</p><p><br /></p><p>Sit back, pat yourself on the back, hopefully the experience taught you its cheaper just to buy a couple more disks and have a good backup handy.</p>
        </div>
    </body>
</html>
